<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MinifyJpegAsync Demo</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="MinifyJpegAsync.js"></script>
</head>
<body>
    長辺の長さ(longside length): <input type="text" id="length" value="480"><br><br>
    <div id="up">JPEG FILES ONLY<br>You can choose multiple files<br></div>
    <div id="status"></div>
    <div id="resized"></div>
<script>
if (typeof window.navigator.msSaveBlob === "undefined") {
    var saveJpeg = null;
} else {
    $("#up").append("IE 10 and 11, left-click on image to save.<br>");
    var n = 0;
    var saveJpeg = function (blob) {
        return function () {
            window.navigator.msSaveBlob(blob, "minifyDemo" + (n++) + ".jpg");
        };
    };
}
    

function DeferChain() {
    this._funcs = [];
}

DeferChain.prototype = {
    concat: function(func){
        this._funcs.push(func);
    },
    
    exec: function(){
        if (this._funcs.length){
            var funcStr = "this._funcs[0]()";
            for (var i=1, func; func=this._funcs[i]; i++){
                funcStr += ".then(this._funcs[" + i + "])";
            }
            eval(funcStr);
        } else {
            throw new Error("No function is given to 'DeferChain' instance.");
        }
    },
};


function handleFileSelect(evt) {
    var length = parseInt($('#length').val());
    var file;
    var jpegs = [];
    if (!length) {
        return;
    }
    var files = evt.target.files; // FileList object
    for (var n = 0; n < files.length; n++) {
        var file = files[n];
        if (!file.type.match('image/jpeg.*')) {
            console.log("Pass: " + file.name);
        } else {
            jpegs.push(file);
        }
    }
    
    var dc = new DeferChain();
    for (var i=0, f; f=jpegs[i]; i++){
        dc.concat(processJpeg(f, length));
    }
    dc.exec();
}
    
var processJpeg = function (f, length){
    return function(){
        console.log("load: " + f.name);
        var d = new $.Deferred();
        var reader = new FileReader();
        var statusEl = $("#status");
        var resizedEl = $("#resized");
        statusEl.html('<div >loading: ' + f.name + '</div>');

        // Jpeg processing
        reader.onloadend = function(e) {
            MinifyJpegAsync.minify(e.target.result, length, function(data){
                //postJpeg(data);
                var enc = "data:image/jpeg;base64," + MinifyJpegAsync.encode64(data);
                var img = new Image();
                img.src = enc;
                if (saveJpeg) {
                    var blob = new Blob([data], {
                        type: "image\/jpeg"
                    });
                    img.onclick = saveJpeg(blob);
                }
                resizedEl.prepend("<br>" + f.name);
                resizedEl.prepend(img);
                resizedEl.prepend("<br><br>");
                
                console.log("processed: " + f.name);
                d.resolve();
            });
        };
        reader.readAsDataURL(f);
        return d.promise();
    };
};


function postJpeg(data) {
    var req = new XMLHttpRequest();
    req.open("POST", "/resize", false);
    req.setRequestHeader('Content-Type', 'image\/jpeg');
    req.send(data.buffer);
}


document.body.onload = function () {
    if (typeof (FileReader) == "function") {
        var html = '<input type="file" id="files" class="form" name="files[]" ' +
                   'onchange="handleFileSelect(event);" multiple /><br>' +
                   '<div id="keika"><div>';
        $('#up').append(html);
    } else {
        var html = '<form action="/up" method="post" enctype="multipart/form-data">' +
            '<fieldset><legend>写真を追加</legend>' +
            '<input type="file" name="photo[]" multiple/><br>' +
            '<input type = "submit" value="写真を送る">' +
            '</fieldset></form><br><br>';
        $('#up').append("");
    }
};
</script>
</body>
</html>